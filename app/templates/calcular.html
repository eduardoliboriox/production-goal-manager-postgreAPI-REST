{% extends "base.html" %}
{% block title %}Calcular Meta — Sistema de Metas{% endblock %}
{% block page_title %}Calcular Meta Ajustada{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- ================= META AJUSTADA ================= -->
  <div class="card shadow-sm p-4 mb-5">
    <h5 class="mb-4">
      <i class="bi bi-calculator-fill text-success"></i>
      Calcular Meta Ajustada
    </h5>

    <form id="calcForm" class="row g-4">
      <div class="col-md-3">
        <label class="form-label fw-semibold">Modelo</label>
        <select class="form-select form-select-lg" name="codigo" required>
          {% for c in codigos %}
            <option>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label fw-semibold">Pessoas atuais</label>
        <input class="form-control form-control-lg" name="pessoas_atuais" type="number" required>
      </div>

      <div class="col-md-3">
        <label class="form-label fw-semibold">Minutos</label>
        <input class="form-control form-control-lg" name="minutos" type="number" value="60" required>
      </div>

      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-success btn-lg w-100" type="submit">
          <i class="bi bi-play-circle"></i> Calcular
        </button>
      </div>
    </form>

    <div id="resultadoCalc"
         class="mt-4 p-3 border rounded shadow-sm bg-light text-center fw-semibold">
    </div>
  </div>

  <!-- ================= CÁLCULO RÁPIDO ================= -->
  <div class="card shadow-sm p-4 mb-5">
    <h5 class="mb-4">
      <i class="bi bi-lightning-charge-fill text-primary"></i>
      Cálculo Rápido (Meta/Hora × Minutos)
    </h5>

    <form id="calcRapidoForm" class="row g-4">

      <div class="col-md-4">
        <label class="form-label fw-semibold">Meta por hora</label>
        <input class="form-control form-control-lg" type="number" name="meta_hora" required>
      </div>

      <div class="col-md-4">
        <label class="form-label fw-semibold">Minutos</label>
        <input class="form-control form-control-lg" type="number" name="minutos" value="60" required>
      </div>

      <div class="col-md-4 d-none" id="campoBlank">
        <label class="form-label fw-semibold">Blank</label>
        <input class="form-control form-control-lg" type="number" name="blank">
      </div>

      <div class="col-md-4 d-flex align-items-center">
        <div class="form-check form-switch mt-4">
          <input class="form-check-input" type="checkbox" id="usarBlank">
          <label class="form-check-label fw-semibold">Considerar Blank</label>
        </div>
      </div>

      <div class="col-md-4 d-flex align-items-end">
        <button class="btn btn-primary btn-lg w-100" type="submit">
          <i class="bi bi-play-circle"></i> Calcular
        </button>
      </div>
    </form>

    <div id="resultadoCalcRapido"
         class="mt-4 p-3 border rounded shadow-sm bg-light text-center fw-semibold">
    </div>
  </div>

  <!-- ================= SMT MANUAL ================= -->
  <div class="card shadow-sm p-4">
    <h5 class="mb-4">
      <i class="bi bi-cpu-fill text-danger"></i>
      Cálculo SMT (Manual / Cronômetro)
    </h5>

    <form id="smtForm" class="row g-3">

      <div class="col-md-4">
        <label class="form-label fw-semibold">Tempo de montagem (s)</label>
        <input name="tempo_montagem"
               class="form-control form-control-lg"
               type="number"
               step="0.01"
               required>
      </div>

      <div class="col-md-4">
        <label class="form-label fw-semibold">Blank</label>
        <input name="blank"
               class="form-control form-control-lg"
               type="number"
               required>
      </div>

      <div class="col-md-4 d-flex align-items-end">
        <button class="btn btn-danger btn-lg w-100" type="submit">
          Calcular Meta SMT
        </button>
      </div>
    </form>

    <div id="resultadoSMT"
         class="mt-4 p-3 border rounded shadow-sm bg-light text-center fw-semibold">
    </div>

    <hr class="my-4">

    <!-- ================= SMT INVERSO ================= -->
    <h6 class="fw-bold">Cálculo Inverso</h6>

    <form id="smtInversoForm" class="row g-3 mt-2">
      <div class="col-md-6">
        <label class="form-label fw-semibold">Meta Hora</label>
        <input name="meta_hora"
               class="form-control form-control-lg"
               type="number"
               required>
      </div>

      <div class="col-md-6">
        <label class="form-label fw-semibold">Blank</label>
        <input name="blank"
               class="form-control form-control-lg"
               type="number"
               required>
      </div>

      <div class="col-12">
        <button class="btn btn-outline-primary btn-lg w-100" type="submit">
          Calcular Tempo de Montagem
        </button>
      </div>
    </form>

    <div id="resultadoInverso"
         class="mt-3 text-center fw-semibold">
    </div>
  </div>

</div>

<!-- ================= JS ================= -->
<script>
// -------- CÁLCULO RÁPIDO --------
document.getElementById("usarBlank").addEventListener("change", e => {
  document.getElementById("campoBlank").classList.toggle("d-none", !e.target.checked);
});

document.getElementById("calcRapidoForm").addEventListener("submit", e => {
  e.preventDefault();

  const f = e.target;
  const meta = Number(f.meta_hora.value);
  const min = Number(f.minutos.value);
  const blank = Number(f.blank?.value || 0);
  const usarBlank = document.getElementById("usarBlank").checked;

  let bruto = (meta / 60) * min;
  let resultado = usarBlank && blank > 0
    ? Math.ceil(bruto / blank) * blank
    : Math.round(bruto);

  document.getElementById("resultadoCalcRapido").innerHTML =
    `Resultado: <strong>${resultado}</strong>`;
});

// -------- SMT META --------
document.getElementById("smtForm").addEventListener("submit", async e => {
  e.preventDefault();

  const resp = await fetch("/api/smt/calcular_meta", {
    method: "POST",
    body: new FormData(e.target)
  });

  const d = await resp.json();

  document.getElementById("resultadoSMT").innerHTML = d.erro
    ? `<span class="text-danger">${d.erro}</span>`
    : `
      Meta Hora: <strong>${d.meta_hora}</strong><br>
      Meta Teórica: ${d.meta_teorica}<br>
      Meta c/ Perda: ${d.meta_com_perda}
    `;
});

// -------- SMT INVERSO --------
document.getElementById("smtInversoForm").addEventListener("submit", async e => {
  e.preventDefault();

  const resp = await fetch("/api/smt/calcular_tempo", {
    method: "POST",
    body: new FormData(e.target)
  });

  const d = await resp.json();

  document.getElementById("resultadoInverso").innerHTML = d.erro
    ? `<span class="text-danger">${d.erro}</span>`
    : `⏱ Tempo de montagem: <strong>${d.tempo_montagem} s</strong>`;
});
</script>

{% endblock %}
