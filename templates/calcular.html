{% extends "base.html" %}
{% block title %}Calcular Meta — Sistema de Metas{% endblock %}
{% block page_title %}Calcular Meta Ajustada{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="card shadow-sm p-4">
    <h5 class="mb-4"><i class="bi bi-calculator-fill text-success"></i> Calcular Meta Ajustada</h5>

    <form id="calcForm" class="row g-4">
      <div class="col-md-3">
        <label class="form-label fw-semibold">Modelo</label>
        <select class="form-select form-select-lg" name="codigo" required>
          {% for c in codigos %}
            <option>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label fw-semibold">Pessoas atuais</label>
        <input class="form-control form-control-lg" name="pessoas_atuais" type="number" required>
      </div>

      <div class="col-md-3">
        <label class="form-label fw-semibold">Minutos</label>
        <input class="form-control form-control-lg" name="minutos" type="number" value="60" required>
      </div>

      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-success btn-lg w-100" type="submit">
          <i class="bi bi-play-circle"></i> Calcular
        </button>
      </div>
    </form>

    <div id="resultadoCalc" class="mt-4 p-3 border rounded shadow-sm bg-light text-center fw-semibold"></div>
  </div>

  <hr class="my-5">

  <div class="card shadow-sm p-4 mt-4">
    <h5 class="mb-4"><i class="bi bi-lightning-charge-fill text-primary"></i> Cálculo Rápido (Meta/Hora x Minutos)</h5>

    <form id="calcRapidoForm" class="row g-4">

      <div class="col-md-4">
        <label class="form-label fw-semibold">Meta por hora</label>
        <input class="form-control form-control-lg" type="number" name="meta_hora" required>
      </div>

      <div class="col-md-4">
        <label class="form-label fw-semibold">Minutos</label>
        <input class="form-control form-control-lg" type="number" name="minutos" value="60" required>
      </div>

      <div class="col-md-4 d-flex align-items-end">
        <button class="btn btn-primary btn-lg w-100" type="submit">
          <i class="bi bi-play-circle"></i> Calcular
        </button>
      </div>

    </form>

    <div id="resultadoCalcRapido" class="mt-4 p-3 border rounded shadow-sm bg-light text-center fw-semibold"></div>
  </div>

</div>

<script>
document.getElementById('calcForm').addEventListener('submit', async e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const resp = await fetch('/calcular_meta', {method:'POST', body: fd});
  const data = await resp.json();
  document.getElementById('resultadoCalc').innerHTML = data.resultado;
});

document.getElementById('calcRapidoForm').addEventListener('submit', e => {
  e.preventDefault();

  const meta_hora = Number(e.target.meta_hora.value);
  const minutos = Number(e.target.minutos.value);

  let bruto = (meta_hora / 60) * minutos;
  let decimal = bruto - Math.floor(bruto);
  let resultado = decimal < 0.50 
                  ? Math.floor(bruto) 
                  : Math.ceil(bruto);


  document.getElementById('resultadoCalcRapido').innerHTML = 
    "Resultado: <strong>" + resultado.toFixed(0) + "</strong>";
});
</script>

{% endblock %}
